'use strict'

//·······················································································································································
//                                                                                                                                                MODULES
//·······················································································································································

const express = require('express')
const subdomain = require('express-subdomain')
const handlebars = require('express-handlebars')
const mongodb = require('mongodb')
const cookieparser = require('cookie-parser')
const dotenv = require('dotenv')
const morgan = require('morgan')

//·······················································································································································
//                                                                                                                                            environment
//·······················································································································································

dotenv.config()

//·······················································································································································
//                                                                                                                                              CONSTANTS
//·······················································································································································

const program = express()

program.use(morgan('dev')) // for dev only

program.use(cookieparser())

//·······················································································································································
//                                                                                                                                                MONGODB
//·······················································································································································

mongodb.MongoClient.connect(`mongodb://${process.env.MONGODB_USERNAME}:${process.env.MONGODB_PASSWORD}@${process.env.MONGODB_HOST}:${process.env.MONGODB_PORT}/?authSource=${process.env.MONGODB_AUTH}`, { useNewUrlParser: true, useUnifiedTopology: true }, (error, mongo) => {
  if (error) return console.error(error)

  console.info(`> connected successfully to the MongoDB database`);
  program.locals.mongo = mongo
})

//·······················································································································································
//                                                                                                                                        TEMPLATE ENGINE
//·······················································································································································

const template = handlebars.create({
  extname: '.hbs'
})

program.engine('.hbs', template.engine)
program.set('view engine', '.hbs')

//·······················································································································································
//                                                                                                                                                 ROUTES
//·······················································································································································

program.use(subdomain('api', require('./routes/api/route')))
program.use(subdomain('core', require('./routes/core/route')))

program.get('/', (request, response) => {
  response.set('X-XSS-Protection', '1; mode=block').send('Root path')
})

//·······················································································································································
//                                                                                                                                                  START
//·······················································································································································

program.listen(8888, () => {
  console.log('live')
})